# Project Context: flrts-extensions

**Last Updated:** 2025-10-22

> This file provides project-specific context for all agents working in the flrts-extensions repository. This is a **component repository** of the larger BigSirFLRTS project.

---

## Relationship to BigSirFLRTS

**THIS IS A COMPONENT OF A LARGER PROJECT**

- **Parent Project:** BigSirFLRTS
- **Parent Repository:** `/Users/colinaulds/Desktop/bigsirflrts`
- **Role:** ERPNext custom app providing FLRTS-specific functionality
- **Deployment Target:** Frappe Cloud (https://ops.10nz.tools)
- **Integration:** Deployed as custom app to ERPNext instance

**When working in this repository:**
- You are working on the custom ERPNext app for BigSirFLRTS
- The main project documentation lives in `/Users/colinaulds/Desktop/bigsirflrts`
- Linear issues are tracked in the BigSirFLRTS project (workspace: 10netzero)
- Architecture decisions (ADRs) are documented in the parent project

---

## Project Overview

- **Name:** flrts_extensions
- **Type:** ERPNext Custom Application (Frappe Framework)
- **Description:** Custom DocTypes, server scripts, reports, and workflow customizations for FLRTS (Field Reports, Lists, Reminders, Tasks, and Sub-Tasks) functionality
- **Repository Path:** `/Users/colinaulds/Desktop/flrts-extensions`
- **GitHub:** `auldsyababua/flrts-extensions`
- **Production Site:** https://ops.10nz.tools (Frappe Cloud Private Bench)
- **Target Users:** Small bitcoin mining operations team (10-20 users)

### What This App Provides

**Custom DocTypes:**
- **FLRTS Parser Log** (35 fields) - AI parsing metadata and cost tracking
- **FLRTS User Preference** (11 fields) - User-specific settings and preferences
- **Contractor** - Mining contractor management
- **Mining Site** - Site information and tracking

**Custom Fields on Standard DocTypes:**
- **Maintenance Visit** - 7 custom fields for FLRTS integration:
  - custom_assigned_to
  - custom_flrts_priority
  - custom_parse_rationale
  - custom_parse_confidence
  - custom_telegram_message_id
  - custom_flrts_source
  - custom_flagged_for_review

**Server Scripts (Scheduled Tasks):**
- FLRTS Daily Cost Monitor
- FLRTS Parser Log Cost Calculation
- FLRTS Parser Log Success Rate Monitor

**Reports:**
- Parser Performance Dashboard
- OpenAI Cost Tracking
- Telegram Message Volume

**Event Handlers & Automations:**
- Task event handlers (automations/task_events.py)
- Telegram webhook handler (automations/telegram_events.py)
- Telegram API integration (automations/telegram_api.py)

---

## Current Work: Code Quality & CI/CD Initiative

**LINEAR ISSUE:** [10N-382](https://linear.app/10netzero/issue/10N-382) - Implement Comprehensive Code Quality & CI/CD

**Status:** Ready for implementation (Planning complete)

**Context:** Linting analysis (October 22, 2025) identified 451 code quality issues. This work brings flrts-extensions to the same rigorous standards as the parent bigsirflrts repository.

### Current Code Quality Status
- **Pylint Score:** 5.78/10 (Target: ≥8.0)
- **Flake8 Issues:** 451 (Target: 0)
- **CI/CD:** None (Target: Full GitHub Actions pipeline)
- **Testing:** No pytest framework (Target: ≥60% coverage)
- **Pre-commit Hooks:** None (Target: Full hook suite)
- **Documentation:** Minimal (Target: CONTRIBUTING.md + comprehensive README)

### Active Child Issues

1. **[10N-383](https://linear.app/10netzero/issue/10N-383): Fix 451 Code Quality Issues** (High Priority)
   - Fix 334 tab/space mixing issues in `openai_cost_tracking.py`
   - Fix 2 bare except statements (must use `except Exception:`)
   - Remove 12 unused imports
   - Fix all PEP 8 violations (trailing whitespace, blank lines, line length, EOF)

2. **[10N-384](https://linear.app/10netzero/issue/10N-384): Configure Linting Tools** (High Priority)
   - Create `pyproject.toml` (black, pylint config)
   - Create `.flake8` config
   - Create `.editorconfig`
   - Create `requirements-dev.txt`

3. **[10N-385](https://linear.app/10netzero/issue/10N-385): Create CI/CD Pipeline** (High Priority)
   - Create `.github/workflows/pr-core.yml` (lint, format, test)
   - Create `.github/workflows/qa-gate.yml` (comprehensive checks)
   - Create `.github/workflows/security.yml` (bandit scan)
   - Configure branch protection rules

4. **[10N-386](https://linear.app/10netzero/issue/10N-386): Set Up pytest Testing** (Normal Priority)
   - Create `tests/unit/` and `tests/integration/` structure
   - Create `pytest.ini`, `.coveragerc`, `conftest.py`
   - Write initial test suite (cost calculation, server scripts, utils)
   - Target: ≥60% coverage

5. **[10N-387](https://linear.app/10netzero/issue/10N-387): Configure Pre-commit Hooks** (Normal Priority)
   - Create `.pre-commit-config.yaml` (black, flake8, pylint, isort, bandit)
   - Create `scripts/install-hooks.sh`
   - Update `pyproject.toml` with bandit/isort config

6. **[10N-388](https://linear.app/10netzero/issue/10N-388): Create Documentation** (Normal Priority)
   - Create `CONTRIBUTING.md` with development guidelines
   - Update `README.md` with CI badges and development section
   - Create `.github/pull_request_template.md`

**Total Effort:** 20-24 hours across 6 issues

---

## Linear Configuration

**THIS REPOSITORY USES THE PARENT PROJECT'S LINEAR WORKSPACE**

- **Workspace:** 10netzero (shared with parent bigsirflrts project)
- **Team:** 10netzero
- **Team ID:** 2b0b568f-e5a6-40ac-866b-367a2564046a
- **Project:** BigSirFLRTS (same as parent)
- **Project ID:** 9d089be4-a284-4879-9b67-f472abecf998
- **Master Dashboard:** [10N-275](https://linear.app/10netzero/issue/10N-275) (in parent project)

**Issue Naming Convention:**
- All issues use 10N-XXX format (10netzero workspace prefix)
- Issues created for flrts-extensions work still belong to BigSirFLRTS project
- Use labels to distinguish: `flrts-extensions`, `code-quality`, `ci-cd`, etc.

---

## Tech Stack

**Primary Language:** Python 3.11+ (matches Frappe Cloud ERPNext v15 default)

**Framework:** Frappe Framework
- ERPNext is built on Frappe
- Apps use Frappe's DocType, Server Script, and Report systems
- Deployed via bench (Frappe's CLI tool)

**Key Dependencies:**
- **frappe** - Provided by Frappe Cloud platform (not in requirements.txt)
- **requests** - HTTP client for external API calls
- **rq** - Redis Queue for background jobs (provided by Frappe)
- **pytest** - Testing framework (dev dependency)

**Deployment Platform:** Frappe Cloud
- **Site:** ops.10nz.tools (builder-rbt-sjk.v.frappe.cloud)
- **Bench:** bench-27276-000006-f1-virginia
- **Region:** US East (Virginia)
- **Deployment Method:** Git push-to-deploy
  1. Push to main branch on GitHub
  2. Trigger deploy via Frappe Cloud UI
  3. SSH to bench and run `bench migrate`
  4. Run `bench restart` to reload changes

**Development Dependencies (requirements-dev.txt):**
- black - Code formatter
- flake8 - PEP 8 linter
- pylint - Advanced linter
- pytest - Test framework
- pytest-cov - Coverage reporting
- pre-commit - Git hook framework
- isort - Import sorter
- bandit - Security scanner

---

## Code Quality Standards

**THESE STANDARDS MATCH THE PARENT BIGSIRFLRTS REPOSITORY**

### Linting Requirements
- **Flake8:** Zero errors (PEP 8 compliance)
- **Pylint:** Score ≥ 8.0/10
- **Black:** Auto-formatted (line length 100)
- **isort:** Imports sorted correctly

### Code Style
- **Line Length:** 100 characters (matches bigsirflrts prettier config)
- **Indentation:** 4 spaces (NO TABS)
- **Line Endings:** LF (not CRLF)
- **EOF:** All files must end with newline
- **Exception Handling:** Use `except Exception:` not bare `except:`

### Testing Requirements
- **Coverage:** ≥60% (initial), ≥80% (long-term)
- **Framework:** pytest
- **Structure:** `tests/unit/` and `tests/integration/`
- **Fixtures:** Shared fixtures in `conftest.py`
- **Mocking:** Mock frappe module for unit tests

### CI/CD Requirements
- **PR Checks:** All checks must pass before merge
  - Lint (flake8, pylint)
  - Format (black)
  - Tests (pytest with coverage)
- **Branch Protection:** main branch requires PR review
- **Pre-commit Hooks:** Run locally before commit

---

## Project Standards & Documentation

**MOST DOCUMENTATION LIVES IN THE PARENT PROJECT**

### Parent Project Documentation
- **Architecture Decisions:** `/Users/colinaulds/Desktop/bigsirflrts/docs/architecture/adr/`
  - ADR-006: ERPNext/Frappe Cloud migration
  - ADR-007: OpenTelemetry standard
- **ERPNext Research:** `/Users/colinaulds/Desktop/bigsirflrts/docs/erpnext/research/`
- **Naming Conventions:** `/Users/colinaulds/Desktop/bigsirflrts/docs/erpnext/ERPNext-Migration-Naming-Standards.md`

### This Repository's Documentation
- **README.md** - App overview, installation, features
- **CONTRIBUTING.md** - Development setup and guidelines (to be created in 10N-388)
- **requirements.txt** - Runtime dependencies (Frappe Cloud provided)
- **requirements-dev.txt** - Development dependencies (to be created in 10N-384)

---

## Project-Specific Conventions

### Git & GitHub

- **Branch Naming:** `feat/10n-xxx-description` or `fix/10n-xxx-description`
- **Commit Format:** Conventional Commits with Linear refs
  ```
  feat(doctypes): add FLRTS Parser Log DocType

  Refs: 10N-XXX
  ```
- **Main Branch:** main
- **Protected:** Yes (requires PR review after CI/CD setup)

### Frappe-Specific Conventions

**Module Structure:**
```
flrts_extensions/
├── flrts/                    # Main module
│   ├── doctype/             # Custom DocTypes
│   ├── report/              # Custom Reports
│   └── server_script/       # Server Scripts
├── automations/             # Event handlers and webhooks
├── fixtures/                # Fixture data (Custom Fields, etc.)
├── hooks.py                 # App hooks and event bindings
├── modules.txt              # Module registry
└── patches.txt              # Migration patches
```

**Naming Conventions:**
- **DocTypes:** PascalCase with spaces (e.g., "FLRTS Parser Log")
- **Fields:** snake_case (e.g., `telegram_message_id`)
- **Custom Fields:** Prefix with `custom_` (e.g., `custom_flrts_source`)
- **Modules:** Uppercase (e.g., "FLRTS", "FLRTS Extensions")

**Deployment Workflow:**
1. Make changes locally
2. Commit and push to GitHub
3. Trigger Frappe Cloud deploy via UI
4. SSH to bench and run migrations
5. Test changes on ops.10nz.tools
6. Update Linear issue status

---

## Recurring Patterns

### Frappe Framework Patterns

**DocType Development:**
- Always use `frappe.get_doc()` to load documents
- Use `frappe.db.get_value()` for single field fetches
- Use `frappe.db.get_list()` for queries with filters
- Always call `doc.save()` to persist changes
- Use `frappe.db.commit()` for transaction control

**Server Scripts:**
- Scripts run in scheduler context (no HTTP request)
- Use `frappe.logger()` for logging
- Catch `Exception` not bare `except:`
- Use `frappe.sendmail()` for alerts
- Test with `bench execute` command

**API Endpoints:**
- Decorate with `@frappe.whitelist(allow_guest=True)` for public endpoints
- Return dict responses (auto-converted to JSON)
- Use `frappe.throw()` for errors (auto-handles HTTP status)
- Validate auth with `frappe.get_user()`

### Testing Patterns

**Unit Tests:**
- Mock frappe module (`@patch('frappe.get_doc')`)
- Test business logic in isolation
- Fast tests (<100ms per test)

**Integration Tests:**
- May require ERPNext instance
- Mark with `@pytest.mark.integration`
- Test interactions between components

### Security

**Secrets Management:**
- Use ENV variables (not hardcoded)
- Frappe provides: `frappe.conf.get('SECRET_NAME')`
- Never commit secrets to git
- Use `.env` for local development (gitignored)

**API Security:**
- Validate webhook secrets
- Use `frappe.whitelist()` decorator
- Check user permissions with `frappe.has_permission()`
- Sanitize user inputs

---

## Known Issues & Blockers

**Current Deployment Status:**
- ✅ DocTypes deployed (FLRTS Parser Log, FLRTS User Preference)
- ⚠️ Custom Fields pending (fixture format fixed, awaiting redeploy)
- ⚠️ Smoke tests: 8/13 passing (target: 13/13 after fixture fix)

**Code Quality Issues:**
- 451 linting issues identified (see 10N-382 child issues)
- No CI/CD pipeline (blocks PR quality gates)
- No automated testing (blocks confident deploys)
- No pre-commit hooks (quality issues reach GitHub)

**Frappe Cloud Limitations:**
- Deployment requires manual UI action (cannot automate)
- SSH certificates expire every 6 hours
- Migrations must be run manually via SSH
- No direct database access (use Frappe ORM only)

---

## Usage Notes for Agents

### When Working in This Repository

1. **Remember the parent project:** Most documentation lives in `/Users/colinaulds/Desktop/bigsirflrts`
2. **Check Linear in parent workspace:** All issues use 10N-XXX format in BigSirFLRTS project
3. **Follow parent standards:** Code quality, testing, CI/CD match bigsirflrts repo
4. **Frappe-specific code:** This repo uses Python + Frappe Framework (not TypeScript/Node.js)
5. **Deployment is different:** Git push-to-deploy, manual migration, Frappe Cloud

### Cross-Repository Work

**If you need to modify both repositories:**
- Start in parent project (`/Users/colinaulds/Desktop/bigsirflrts`) for planning
- Create Linear issues in BigSirFLRTS project
- Execute changes in this repo when working on ERPNext customizations
- Update parent repo when working on client-side code, Lambda functions, or docs

**Common Cross-Repo Scenarios:**
- **Telegram webhook:** Handler code here (Python), integration tests in parent (TypeScript)
- **ERPNext API calls:** Client libraries in parent, server-side logic here
- **Documentation:** ERPNext-specific docs in parent `/docs/erpnext/`, app docs here
- **Testing:** Integration tests may need both repos (mock ERPNext in parent, real ERPNext here)

### Getting Help

**For Frappe/ERPNext questions:**
- Check parent docs: `/Users/colinaulds/Desktop/bigsirflrts/docs/erpnext/research/`
- Check Frappe docs: https://frappeframework.com/docs
- Check ERPNext docs: https://docs.erpnext.com

**For project context:**
- Read parent `.project-context.md` for overall project context
- Read this file for flrts-extensions-specific context
- Check Linear issue 10N-382 for current work status

**For deployment:**
- See parent docs: `/Users/colinaulds/Desktop/bigsirflrts/docs/research/frappe-cloud-deployment-workflow.md`
- See parent docs: `/Users/colinaulds/Desktop/bigsirflrts/docs/auth/erpnext-access.md` (SSH workarounds)

---

**Project Version:** Active Development
**Framework:** linear-first-agentic-workflow (inherited from parent)
**Parent Project:** BigSirFLRTS
**Last Synced:** 2025-10-22
